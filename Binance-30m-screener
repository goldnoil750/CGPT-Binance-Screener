import express from "express";
import fetch from "node-fetch";

const app = express();
app.use(express.static("public"));

async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
  return await res.json();
}

// ðŸ§  Get Binance Perp pairs list (USDT only)
async function getPerpPairs() {
  const url =
    "https://api.codetabs.com/v1/proxy/?quest=https://fapi.binance.com/fapi/v1/exchangeInfo";
  const data = await fetchJSON(url);
  return data.symbols
    .filter((s) => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
    .map((s) => s.symbol);
}

// ðŸ“Š Get last 3 closed 30m candles (we use Candle(1) & Candle(2))
async function getKlines(symbol) {
  const url = `https://api.codetabs.com/v1/proxy/?quest=https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=30m&limit=3`;
  const data = await fetchJSON(url);
  return data.map((k) => ({
    open: parseFloat(k[1]),
    high: parseFloat(k[2]),
    low: parseFloat(k[3]),
    close: parseFloat(k[4]),
    volume: parseFloat(k[5]),
  }));
}

// ðŸ§® Calculate body %
function bodyPct(c) {
  return ((c.close - c.open) / c.open) * 100;
}

// ðŸš€ Main screener logic
async function getScreenerData() {
  const pairs = await getPerpPairs();
  const results = [];

  for (const symbol of pairs) {
    try {
      const kl = await getKlines(symbol);
      const c2 = kl[0]; // candle(2)
      const c1 = kl[1]; // candle(1)
      const body1 = bodyPct(c1);
      const body2 = bodyPct(c2);

      // Only if Candle(1) is GREEN and â‰¥2%
      if (body1 >= 2) {
        const volRatio = c2.volume / c1.volume;
        results.push({
          symbol,
          volRatio: volRatio.toFixed(2),
          body1_pct: body1.toFixed(2),
          body2_pct: body2.toFixed(2),
          vol1: c1.volume.toFixed(0),
          vol2: c2.volume.toFixed(0),
        });
      }
    } catch (e) {
      console.error(`Error ${symbol}:`, e.message);
    }
  }

  // Sort by Volume Ratio descending
  results.sort((a, b) => b.volRatio - a.volRatio);
  return results;
}

// ðŸ§¾ Endpoint for browser
app.get("/data", async (req, res) => {
  try {
    const data = await getScreenerData();
    res.json({ ok: true, data });
  } catch (e) {
    res.json({ ok: false, error: e.message });
  }
});

// ðŸ–¥ï¸ Web UI
app.get("/", (req, res) => {
  res.send(`<!DOCTYPE html>
<html>
<head>
<title>Binance Perp 30-min Screener</title>
<style>
body { font-family: Arial; margin: 20px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #f5f5f5; }
</style>
</head>
<body>
<h2>Binance Perp 30-min Screener</h2>
Refresh (sec): <input id="interval" type="number" value="60" style="width:70px">
<button onclick="applyInterval()">Apply</button>
<button onclick="loadData()">Refresh Now</button>
<span id="countdown"></span>
<br><br>
<table id="dataTable">
<thead>
<tr>
<th>Pair Name</th>
<th>Vol Ratio</th>
<th>Body(1)%</th>
<th>Body(2)%</th>
<th>Vol(1)</th>
<th>Vol(2)</th>
</tr>
</thead>
<tbody></tbody>
</table>
<script>
let refreshInterval = 60;
let countdown = refreshInterval;
let timerId;

function applyInterval() {
  const val = parseInt(document.getElementById('interval').value);
  if (val > 5) {
    refreshInterval = val;
    countdown = val;
  }
}

async function loadData() {
  document.querySelector("#dataTable tbody").innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
  try {
    const res = await fetch('/data');
    const js = await res.json();
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = '';
    if (js.ok && js.data.length > 0) {
      js.data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = \`<td style="text-align:left">\${r.symbol}</td><td>\${r.volRatio}</td><td>\${r.body1_pct}</td><td>\${r.body2_pct}</td><td>\${r.vol1}</td><td>\${r.vol2}</td>\`;
        tbody.appendChild(tr);
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="6">No data</td></tr>';
    }
  } catch(e) {
    console.error(e);
    document.querySelector("#dataTable tbody").innerHTML = '<tr><td colspan="6">Error fetching data</td></tr>';
  }
}

function startTimer() {
  if (timerId) clearInterval(timerId);
  timerId = setInterval(() => {
    document.getElementById('countdown').textContent = 'Next scan in: ' + countdown + 's';
    countdown--;
    if (countdown <= 0) {
      countdown = refreshInterval;
      loadData();
    }
  }, 1000);
}

loadData();
startTimer();
</script>
</body>
</html>`);
});

// Render port
const PORT = process.env.PORT || 10000;
app.listen(PORT, () => console.log("Server running on port", PORT));
